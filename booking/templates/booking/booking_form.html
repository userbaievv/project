{% extends 'booking/base.html' %}

{% block title %}{% if form.instance.pk %}Редактировать{% else %}Создать{% endif %} бронирование{% endblock %}

{% block content %}
<h2 class="mb-4 text-center">{% if form.instance.pk %}Редактировать{% else %}Создать{% endif %} бронирование</h2>

<div class="row">
  <div class="col-lg-4 col-md-5">
    <div class="card shadow">
      <div class="card-body">
        <form method="post">
          {% csrf_token %}
          {% for field in form %}
            <div class="mb-3">
              {{ field.label_tag }}
              {{ field }}
              {% if field.errors %}
                <div class="text-danger small">{{ field.errors }}</div>
              {% endif %}
            </div>
          {% endfor %}
          <div class="d-grid gap-2">
            <button type="submit" class="btn btn-primary">Сохранить</button>
            <a href="{% url 'booking_list' %}" class="btn btn-secondary">Назад</a>
          </div>
        </form>
      </div>
    </div>
  </div>

  <div class="col-lg-8 col-md-7 mt-4 mt-md-0">
    <div class="card shadow h-100">
      <div class="card-body">
        <h5 class="card-title text-center mb-4">Карта столов</h5>

        <div class="d-flex justify-content-end mb-3">
          <div class="btn-group" role="group">
            <button class="btn btn-outline-primary btn-sm" onclick="showFloor(1)">Этаж 1</button>
            <button class="btn btn-outline-primary btn-sm" onclick="showFloor(2)">Этаж 2</button>
          </div>
        </div>

        {% comment %} Первый этаж: столы 1–5 {% endcomment %}
        <div id="floor-1" class="table-map">
          {% for table in tables %}
            {% if table.id <= 5 %}
              <div class="table-container {% if table.booked %}booked{% endif %} {% if table.editing %}editing{% endif %}"
                   style="top: {% if table.id == 1 %}40px{% elif table.id == 2 %}160px{% elif table.id == 3 %}350px{% elif table.id == 4 %}310px{% elif table.id == 5 %}80px{% endif %};
                          left: {% if table.id == 1 %}60px{% elif table.id == 2 %}320px{% elif table.id == 3 %}150px{% elif table.id == 4 %}520px{% elif table.id == 5 %}600px{% endif %};">
                <div class="table-circle"></div>
                {% for angle in chair_angles %}
                  <div class="chair chair-{{ angle }} {% if table.editing %}editing-chair{% endif %}"></div>
                {% endfor %}
                <div class="table-info">
                  <strong>Номер стола:</strong> {{ table.id }}<br>
                  <strong>Кол-во мест:</strong> 6<br>
                  <strong>Статус:</strong>
                  {% if table.editing %}Редактируется
                  {% elif table.booked %}Занят
                  {% else %}Свободен
                  {% endif %}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>

        {% comment %} Второй этаж: столы 6–11 {% endcomment %}
        <div id="floor-2" class="table-map d-none">
          {% for table in tables %}
            {% if table.id > 5 %}
              <div class="table-container {% if table.booked %}booked{% endif %} {% if table.editing %}editing{% endif %}"
                   style="top: {% if table.id == 6 %}50px{% elif table.id == 7 %}140px{% elif table.id == 8 %}60px{% elif table.id == 9 %}280px{% elif table.id == 10 %}280px{% elif table.id == 11 %}380px{% endif %};
                          left: {% if table.id == 6 %}100px{% elif table.id == 7 %}350px{% elif table.id == 8 %}600px{% elif table.id == 9 %}130px{% elif table.id == 10 %}640px{% elif table.id == 11 %}350px{% endif %};">
                <div class="table-circle"></div>
                {% for angle in chair_angles %}
                  <div class="chair chair-{{ angle }} {% if table.editing %}editing-chair{% endif %}"></div>
                {% endfor %}
                <div class="table-info">
                  <strong>Номер стола:</strong> {{ table.id }}<br>
                  <strong>Кол-во мест:</strong> 6<br>
                  <strong>Статус:</strong>
                  {% if table.editing %}Редактируется
                  {% elif table.booked %}Занят
                  {% else %}Свободен
                  {% endif %}
                </div>
              </div>
            {% endif %}
          {% endfor %}
        </div>

      </div>
    </div>
  </div>
</div>

<style>
.table-map {
  position: relative;
  height: 500px;
  background: linear-gradient(135deg, #f5f7fa, #e4e8ec);
  border: 2px dashed #ced4da;
  border-radius: 12px;
  overflow: hidden;
}
.table-container {
  position: absolute;
  width: 100px;
  height: 100px;
  transition: transform 0.3s ease, box-shadow 0.3s ease;
}
.table-container:hover {
  transform: scale(1.1);
  z-index: 20;
}
.table-container:hover .table-circle,
.table-container:hover .chair {
  box-shadow: 0 0 10px rgba(0, 123, 255, 0.6);
  border: 2px solid rgba(0, 123, 255, 0.5);
}
.table-circle {
  width: 100px;
  height: 100px;
  border-radius: 50%;
  background: radial-gradient(circle at center, #6c757d, #495057);
  box-shadow: 0 0 10px rgba(0,0,0,0.2);
  transition: all 0.3s ease;
}
.table-container.booked .table-circle {
  background: radial-gradient(circle at center, #dc3545, #b02a37);
  border: 3px solid #dc3545;
}
.table-container.editing .table-circle {
  background: radial-gradient(circle at center, #ffc107, #e0a800);
  border: 3px solid #ffc107;
}
.chair {
  position: absolute;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: #adb5bd;
  box-shadow: 0 0 5px rgba(0,0,0,0.1);
  transition: all 0.3s ease;
}
.chair-0   { transform: rotate(0deg)   translateY(-60px) rotate(0deg);    top: 40px; left: 40px; }
.chair-60  { transform: rotate(60deg)  translateY(-60px) rotate(-60deg);  top: 40px; left: 40px; }
.chair-120 { transform: rotate(120deg) translateY(-60px) rotate(-120deg); top: 40px; left: 40px; }
.chair-180 { transform: rotate(180deg) translateY(-60px) rotate(-180deg); top: 40px; left: 40px; }
.chair-240 { transform: rotate(240deg) translateY(-60px) rotate(-240deg); top: 40px; left: 40px; }
.chair-300 { transform: rotate(300deg) translateY(-60px) rotate(-300deg); top: 40px; left: 40px; }
.table-info {
  display: none;
  position: absolute;
  top: 0;
  left: 110px;
  width: 140px;
  padding: 8px;
  background: #ffffff;
  border: 1px solid #dee2e6;
  border-radius: 8px;
  box-shadow: 0 4px 10px rgba(0,0,0,0.1);
  font-size: 13px;
  z-index: 30;
}
.table-container:hover .table-info {
  display: block;
}
.chair.editing-chair {
  background: #ffc107;
  box-shadow: 0 0 10px rgba(255, 193, 7, 0.6);
}
</style>

<script>
function showFloor(floor) {
  document.getElementById('floor-1').classList.add('d-none');
  document.getElementById('floor-2').classList.add('d-none');
  document.getElementById(`floor-${floor}`).classList.remove('d-none');
}
</script>
{% endblock %}
